import{s as w,g as m,t as T,i as E,d as M}from"../assets/index-CJMINZqK.js";const L=5e3,D=1e4;function R(e,t){return`${chrome.runtime.getURL("blocked.html")}?site=${encodeURIComponent(e)}&reason=${t}`}async function y(){const e=await m(),{blockedItems:t,settings:s,focusMode:a}=e;if(!s.blockingEnabled){await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:await b(),addRules:[]});return}const r=[];if(T(),s.whitelistMode){r.push({id:L,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{url:R("this site","blocked")}},condition:{urlFilter:"*",resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}});let n=1;for(const i of t)r.push({id:n++,priority:2,action:{type:chrome.declarativeNetRequest.RuleActionType.ALLOW},condition:{requestDomains:[i.url],resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}else{let n=1;for(const i of t){const u=i.dailyLimitMinutes!==void 0&&i.screenTimeToday>=i.dailyLimitMinutes,l=Date.now();if(i.temporaryAllowUntil!==void 0&&i.temporaryAllowUntil>l)continue;const d=!!i.schedule,f=d&&E(i.schedule);if(!(i.limitOnly?u:!d||f||u))continue;const h=u?"limit":f?"schedule":"blocked";i.type==="keyword"?r.push({id:n++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{url:R(i.url,h)}},condition:{urlFilter:`*${i.url}*`,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}}):r.push({id:n++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{url:R(i.url,h)}},condition:{requestDomains:[i.url],resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}}if(a.isActive&&a.phase==="work"){const n=[{id:D,priority:3,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{url:R("this site","focus")}},condition:{urlFilter:"*",resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}},...a.whitelistedDomains.map((i,u)=>({id:D+u+1,priority:4,action:{type:chrome.declarativeNetRequest.RuleActionType.ALLOW},condition:{requestDomains:[i],resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}}))];try{await chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:await I(),addRules:n})}catch(i){console.error("Session rules error:",i)}}else try{await chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:await I(),addRules:[]})}catch{}await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:await b(),addRules:r})}async function b(){return(await chrome.declarativeNetRequest.getDynamicRules()).map(t=>t.id)}async function I(){try{return(await chrome.declarativeNetRequest.getSessionRules()).map(t=>t.id)}catch{return[]}}async function A(){const e=await chrome.alarms.getAll();for(const s of e)s.name.startsWith("schedule_")&&chrome.alarms.clear(s.name);const t=await m();for(const s of t.blockedItems){if(!s.schedule)continue;const{days:a,startTime:r,endTime:n}=s.schedule,i=new Date,u=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];for(let l=0;l<7;l++){const c=new Date(i);c.setDate(c.getDate()+l);const d=u[c.getDay()];if(!a.includes(d))continue;const[f,o]=r.split(":").map(Number),[h,k]=n.split(":").map(Number),p=new Date(c);p.setHours(f,o,0,0);const g=new Date(c);g.setHours(h,k,0,0),p>i&&chrome.alarms.create(`schedule_start_${s.id}_${l}`,{when:p.getTime()}),g>i&&chrome.alarms.create(`schedule_end_${s.id}_${l}`,{when:g.getTime()})}}}async function _(){const e=T(),t=await m();if(t.lastDailyReset===e)return;const s=t.blockedItems.map(a=>({...a,screenTimeToday:0}));await w({blockedItems:s,lastDailyReset:e}),await y()}async function N(e,t){const s=await m(),a=t/60,r=T(),n=[...s.insights],i=n.findIndex(o=>o.domain===e&&o.date===r);i>=0?n[i]={...n[i],totalMinutes:n[i].totalMinutes+a,visitCount:n[i].visitCount+1}:n.push({domain:e,date:r,visitCount:1,totalMinutes:a});const u=s.blockedItems.map(o=>o.url===e||o.url===`www.${e}`?{...o,screenTimeToday:(o.screenTimeToday??0)+a}:o);await w({insights:n,blockedItems:u});const l=u.find(o=>o.dailyLimitMinutes!==void 0&&o.screenTimeToday>=o.dailyLimitMinutes&&o.url===e);l&&(chrome.notifications.create(`limit_${e}`,{type:"basic",iconUrl:"icons/icon48.png",title:"Daily Limit Reached",message:`You've used your ${l.dailyLimitMinutes} min limit for ${e}. It's now blocked.`}),await y());const c=T();for(const o of u)if(o.url===e&&o.dailyLimitMinutes!==void 0&&o.warningFiredAt!==c&&o.screenTimeToday>=o.dailyLimitMinutes*.8&&o.screenTimeToday<o.dailyLimitMinutes){const h=Math.round(o.dailyLimitMinutes-o.screenTimeToday);chrome.notifications.create(`warn_${e}`,{type:"basic",iconUrl:"icons/icon48.png",title:"âš ï¸ Almost at your limit",message:`Only ${h} min left for ${e} today.`});const k=u.map(p=>p.url===e?{...p,warningFiredAt:c}:p);await w({blockedItems:k});break}const d=await m(),f=d.settings.breakReminderMinutes??30;if(f>0){const o=d.continuousBrowsingStart??Date.now(),h=(Date.now()-o)/6e4;d.continuousBrowsingStart?h>=f&&(chrome.notifications.create("break_reminder",{type:"basic",iconUrl:"icons/icon48.png",title:"â˜• Time for a break!",message:`You've been browsing for ${Math.round(h)} minutes. Take a short break.`}),await w({continuousBrowsingStart:Date.now()})):await w({continuousBrowsingStart:Date.now()})}}async function $(){const e=await m(),{focusMode:t}=e,s=Date.now(),a=s+t.workMinutes*60*1e3;await M({isActive:!0,phase:"work",currentSession:1,startedAt:s,phaseEndsAt:a}),chrome.alarms.create("focus_phase_end",{when:a}),chrome.alarms.create("focus_tick",{periodInMinutes:1/60}),await y(),S(),e.settings.showNotifications&&chrome.notifications.create("focus_start",{type:"basic",iconUrl:"icons/icon48.png",title:"Focus Session Started",message:`${t.workMinutes} min work session. Stay focused!`})}async function v(){await M({isActive:!1,phase:"idle",currentSession:1}),chrome.alarms.clear("focus_phase_end"),chrome.alarms.clear("focus_tick"),await y(),S()}async function F(){const e=await m(),{focusMode:t}=e;if(t.isActive){if(t.phase==="work"){const s=Date.now(),a=s+t.breakMinutes*60*1e3;await M({phase:"break",phaseEndsAt:a,startedAt:s}),chrome.alarms.create("focus_phase_end",{when:a}),chrome.notifications.create("focus_break",{type:"basic",iconUrl:"icons/icon48.png",title:"Break Time!",message:`Session ${t.currentSession} complete. Take a ${t.breakMinutes} min break.`})}else if(t.phase==="break"){const s=t.currentSession+1;if(s>t.totalSessions){await v(),chrome.notifications.create("focus_done",{type:"basic",iconUrl:"icons/icon48.png",title:"Focus Session Complete!",message:`All ${t.totalSessions} sessions done. Great work!`});return}const a=Date.now(),r=a+t.workMinutes*60*1e3;await M({phase:"work",currentSession:s,phaseEndsAt:r,startedAt:a}),chrome.alarms.create("focus_phase_end",{when:r}),chrome.notifications.create(`focus_work_${s}`,{type:"basic",iconUrl:"icons/icon48.png",title:"Back to Work",message:`Session ${s} of ${t.totalSessions}. Focus!`})}await y(),S()}}function S(){m().then(e=>{chrome.runtime.sendMessage({type:"FOCUS_STATE_UPDATE",state:e.focusMode}).catch(()=>{})})}async function U(){const e=await m(),t=T();if(!e.settings.dailySummaryEnabled||e.lastDailySummary===t)return;const s=e.insights.filter(c=>c.date===t);if(s.length===0)return;const a=Math.round(s.reduce((c,d)=>c+d.totalMinutes,0)),r=s.sort((c,d)=>d.totalMinutes-c.totalMinutes)[0],n=e.blockedItems.filter(c=>c.dailyLimitMinutes!==void 0&&c.screenTimeToday>=c.dailyLimitMinutes).length,i=Math.floor(a/60),u=a%60,l=i>0?`${i}h ${u}m`:`${u}m`;chrome.notifications.create("daily_summary",{type:"basic",iconUrl:"icons/icon48.png",title:"ðŸ“Š Your Daily Summary",message:`Total browsing: ${l}. Top site: ${(r==null?void 0:r.domain)??"none"}. Limits hit: ${n}.`}),await w({lastDailySummary:t})}chrome.runtime.onInstalled.addListener(async()=>{await _(),await y(),await A();const e=new Date;e.setDate(e.getDate()+1),e.setHours(0,0,0,0),chrome.alarms.create("daily_reset",{when:e.getTime(),periodInMinutes:24*60});const t=new Date;t.setHours(21,0,0,0),t<=new Date&&t.setDate(t.getDate()+1),chrome.alarms.create("daily_summary",{when:t.getTime(),periodInMinutes:24*60})});chrome.runtime.onStartup.addListener(async()=>{if(await _(),await y(),await A(),await w({continuousBrowsingStart:Date.now()}),!await chrome.alarms.get("daily_summary")){const t=new Date;t.setHours(21,0,0,0),t<=new Date&&t.setDate(t.getDate()+1),chrome.alarms.create("daily_summary",{when:t.getTime(),periodInMinutes:24*60})}});chrome.storage.local.onChanged.addListener(e=>{("blockedItems"in e||"settings"in e||"focusMode"in e)&&(y(),"blockedItems"in e&&A())});chrome.alarms.onAlarm.addListener(async e=>{e.name==="daily_reset"?await _():e.name==="daily_summary"?await U():e.name.startsWith("schedule_")?await y():e.name==="focus_phase_end"&&await F()});chrome.runtime.onMessage.addListener((e,t,s)=>{if(e.type==="TRACK_TIME")N(e.domain,e.seconds),s({ok:!0});else{if(e.type==="START_FOCUS")return $().then(()=>s({ok:!0})),!0;if(e.type==="STOP_FOCUS")return v().then(()=>s({ok:!0})),!0;if(e.type==="GET_FOCUS_STATE")return m().then(a=>s({state:a.focusMode})),!0;if(e.type==="REBUILD_RULES")return y().then(()=>s({ok:!0})),!0;if(e.type==="TEMPORARY_ALLOW"){const{domain:a,minutes:r}=e;return m().then(async n=>{const i=Date.now()+r*60*1e3,u=n.blockedItems.map(l=>l.url===a?{...l,temporaryAllowUntil:i}:l);await w({blockedItems:u}),await y(),s({ok:!0})}),!0}}});
