import{g as d,t as w,s as I,i as g,d as y}from"../assets/index-D_hri1Jd.js";const N=5e3,A=1e4;function h(e,s){return`${chrome.runtime.getURL("blocked.html")}?site=${encodeURIComponent(e)}&reason=${s}`}async function u(){const e=await d(),{blockedItems:s,settings:t,focusMode:o}=e;if(!t.blockingEnabled){await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:await S(),addRules:[]});return}const r=[];if(w(),t.whitelistMode){r.push({id:N,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{url:h("this site","blocked")}},condition:{urlFilter:"*",resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}});let c=1;for(const i of s)r.push({id:c++,priority:2,action:{type:chrome.declarativeNetRequest.RuleActionType.ALLOW},condition:{requestDomains:[i.url],resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}else{let c=1;for(const i of s){const l=i.dailyLimitMinutes!==void 0&&i.screenTimeToday>=i.dailyLimitMinutes,n=!!i.schedule,a=n&&g(i.schedule);if(!(!n||a||l))continue;const m=l?"limit":a?"schedule":"blocked";i.type==="keyword"?r.push({id:c++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{url:h(i.url,m)}},condition:{urlFilter:`*${i.url}*`,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}}):r.push({id:c++,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{url:h(i.url,m)}},condition:{requestDomains:[i.url],resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}})}}if(o.isActive&&o.phase==="work"){const c=[{id:A,priority:3,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{url:h("this site","focus")}},condition:{urlFilter:"*",resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}},...o.whitelistedDomains.map((i,l)=>({id:A+l+1,priority:4,action:{type:chrome.declarativeNetRequest.RuleActionType.ALLOW},condition:{requestDomains:[i],resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME]}}))];try{await chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:await M(),addRules:c})}catch(i){console.error("Session rules error:",i)}}else try{await chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:await M(),addRules:[]})}catch{}await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:await S(),addRules:r})}async function S(){return(await chrome.declarativeNetRequest.getDynamicRules()).map(s=>s.id)}async function M(){try{return(await chrome.declarativeNetRequest.getSessionRules()).map(s=>s.id)}catch{return[]}}async function R(){const e=await chrome.alarms.getAll();for(const t of e)t.name.startsWith("schedule_")&&chrome.alarms.clear(t.name);const s=await d();for(const t of s.blockedItems){if(!t.schedule)continue;const{days:o,startTime:r,endTime:c}=t.schedule,i=new Date,l=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];for(let n=0;n<7;n++){const a=new Date(i);a.setDate(a.getDate()+n);const k=l[a.getDay()];if(!o.includes(k))continue;const[m,b]=r.split(":").map(Number),[D,E]=c.split(":").map(Number),p=new Date(a);p.setHours(m,b,0,0);const f=new Date(a);f.setHours(D,E,0,0),p>i&&chrome.alarms.create(`schedule_start_${t.id}_${n}`,{when:p.getTime()}),f>i&&chrome.alarms.create(`schedule_end_${t.id}_${n}`,{when:f.getTime()})}}}async function T(){const e=w(),s=await d();if(s.lastDailyReset===e)return;const t=s.blockedItems.map(o=>({...o,screenTimeToday:0}));await I({blockedItems:t,lastDailyReset:e}),await u()}async function F(e,s){const t=await d(),o=s/60,r=w(),c=[...t.insights],i=c.findIndex(a=>a.domain===e&&a.date===r);i>=0?c[i]={...c[i],totalMinutes:c[i].totalMinutes+o,visitCount:c[i].visitCount+1}:c.push({domain:e,date:r,visitCount:1,totalMinutes:o});const l=t.blockedItems.map(a=>a.url===e||a.url===`www.${e}`?{...a,screenTimeToday:(a.screenTimeToday??0)+o}:a);await I({insights:c,blockedItems:l});const n=l.find(a=>a.dailyLimitMinutes!==void 0&&a.screenTimeToday>=a.dailyLimitMinutes&&a.url===e);n&&(chrome.notifications.create(`limit_${e}`,{type:"basic",iconUrl:"icons/icon48.png",title:"Daily Limit Reached",message:`You've used your ${n.dailyLimitMinutes} min limit for ${e}. It's now blocked.`}),await u())}async function L(){const e=await d(),{focusMode:s}=e,t=Date.now(),o=t+s.workMinutes*60*1e3;await y({isActive:!0,phase:"work",currentSession:1,startedAt:t,phaseEndsAt:o}),chrome.alarms.create("focus_phase_end",{when:o}),chrome.alarms.create("focus_tick",{periodInMinutes:1/60}),await u(),_(),e.settings.showNotifications&&chrome.notifications.create("focus_start",{type:"basic",iconUrl:"icons/icon48.png",title:"Focus Session Started",message:`${s.workMinutes} min work session. Stay focused!`})}async function v(){await y({isActive:!1,phase:"idle",currentSession:1}),chrome.alarms.clear("focus_phase_end"),chrome.alarms.clear("focus_tick"),await u(),_()}async function q(){const e=await d(),{focusMode:s}=e;if(s.isActive){if(s.phase==="work"){const t=Date.now(),o=t+s.breakMinutes*60*1e3;await y({phase:"break",phaseEndsAt:o,startedAt:t}),chrome.alarms.create("focus_phase_end",{when:o}),chrome.notifications.create("focus_break",{type:"basic",iconUrl:"icons/icon48.png",title:"Break Time!",message:`Session ${s.currentSession} complete. Take a ${s.breakMinutes} min break.`})}else if(s.phase==="break"){const t=s.currentSession+1;if(t>s.totalSessions){await v(),chrome.notifications.create("focus_done",{type:"basic",iconUrl:"icons/icon48.png",title:"Focus Session Complete!",message:`All ${s.totalSessions} sessions done. Great work!`});return}const o=Date.now(),r=o+s.workMinutes*60*1e3;await y({phase:"work",currentSession:t,phaseEndsAt:r,startedAt:o}),chrome.alarms.create("focus_phase_end",{when:r}),chrome.notifications.create(`focus_work_${t}`,{type:"basic",iconUrl:"icons/icon48.png",title:"Back to Work",message:`Session ${t} of ${s.totalSessions}. Focus!`})}await u(),_()}}function _(){d().then(e=>{chrome.runtime.sendMessage({type:"FOCUS_STATE_UPDATE",state:e.focusMode}).catch(()=>{})})}chrome.runtime.onInstalled.addListener(async()=>{await T(),await u(),await R();const e=new Date;e.setDate(e.getDate()+1),e.setHours(0,0,0,0),chrome.alarms.create("daily_reset",{when:e.getTime(),periodInMinutes:24*60})});chrome.runtime.onStartup.addListener(async()=>{await T(),await u(),await R()});chrome.storage.local.onChanged.addListener(e=>{("blockedItems"in e||"settings"in e||"focusMode"in e)&&(u(),"blockedItems"in e&&R())});chrome.alarms.onAlarm.addListener(async e=>{e.name==="daily_reset"?await T():e.name.startsWith("schedule_")?await u():e.name==="focus_phase_end"&&await q()});chrome.runtime.onMessage.addListener((e,s,t)=>{if(e.type==="TRACK_TIME")F(e.domain,e.seconds),t({ok:!0});else{if(e.type==="START_FOCUS")return L().then(()=>t({ok:!0})),!0;if(e.type==="STOP_FOCUS")return v().then(()=>t({ok:!0})),!0;if(e.type==="GET_FOCUS_STATE")return d().then(o=>t({state:o.focusMode})),!0;if(e.type==="REBUILD_RULES")return u().then(()=>t({ok:!0})),!0}});
